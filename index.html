<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Kod Okuyucu</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* Sayfa kaydırmasını engelle */
            background-color: #333;
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #qr-reader-container {
            width: 100vw;
            height: 100dvh; /* Dinamik viewport yüksekliği */
            position: relative;
            display: flex; /* İçeriği ortalamak için */
            align-items: center; /* Dikey ortalama */
            justify-content: center; /* Yatay ortalama */
        }

        #qr-reader {
            width: 90%; /* Okuyucu alanının genişliği */
            max-width: 600px; /* Maksimum genişlik */
            border: none; /* Kütüphanenin kendi çerçevesini kaldırabiliriz */
            position: relative;
        }

        /* Tarama bölgesi için özel çerçeve (isteğe bağlı, kütüphane kendi çerçevesini sağlar) */
        #qr-reader__scan_region {
            border: 5px solid #00ff00 !important; /* Yeşil ve belirgin çerçeve */
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }

        #status-container {
            text-align: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            margin-top: 20px;
        }

        #result-message {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #4CAF50;
        }

        #retry-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1em;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #retry-button:hover {
            background-color: #0056b3;
        }

        #error-message {
            color: #ff4d4d;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div id="qr-reader-container">
        <div id="qr-reader"></div>
    </div>

    <div id="status-container" style="display: none;">
        <p id="result-message"></p>
        <button id="retry-button">Yeniden Okut</button>
        <p id="error-message"></p>
    </div>

    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>

    <script>
        const discordWebhookUrl = "https://discord.com/api/webhooks/1376277413570285629/cNxAOeQC7i0sR8CEu-53aPhyNtGCet71uJegvxTJKHkY8Y1NwnBueC2NUq-mYyMFajAR";
        const qrCodePrefixToRemove = "https://monitoring.e-kassa.gov.az/#/index?doc=";

        const qrReaderContainer = document.getElementById('qr-reader-container');
        const qrReaderElement = document.getElementById('qr-reader');
        const statusContainer = document.getElementById('status-container');
        const resultMessage = document.getElementById('result-message');
        const retryButton = document.getElementById('retry-button');
        const errorMessageElement = document.getElementById('error-message');

        let html5QrCode = null;

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`QR Kod okundu: ${decodedText}`);
            html5QrCode.stop().then((ignore) => {
                qrReaderContainer.style.display = 'none';
                statusContainer.style.display = 'block';
                resultMessage.textContent = "QR kod okundu!";
                errorMessageElement.textContent = ''; // Başarılı olunca hata mesajını temizle

                processAndSendToDiscord(decodedText);
            }).catch((err) => {
                console.error("Kamera durdurulamadı.", err);
                qrReaderContainer.style.display = 'none';
                statusContainer.style.display = 'block';
                resultMessage.textContent = "QR kod okundu ama kamera durdurulamadı!";
                processAndSendToDiscord(decodedText); // Yine de işlemeye çalış
            });
        }

        function processAndSendToDiscord(scannedData) {
            let processedData = scannedData;
            if (scannedData.startsWith(qrCodePrefixToRemove)) {
                processedData = scannedData.substring(qrCodePrefixToRemove.length);
            }
            const finalData = processedData.substring(0, 12);

            console.log(`İşlenmiş veri: ${finalData}`);

            fetch(discordWebhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: `Taranan Kod: ${finalData}`
                }),
            })
            .then(response => {
                if (response.ok) {
                    console.log("Mesaj Discord'a başarıyla gönderildi.");
                    resultMessage.textContent += " Kod Discord'a gönderildi.";
                } else {
                    console.error("Discord'a mesaj gönderilemedi. Durum:", response.status);
                    resultMessage.textContent += " Kod Discord'a gönderilemedi.";
                    errorMessageElement.textContent = `Discord Hata: ${response.status}`;
                }
            })
            .catch(error => {
                console.error("Discord'a gönderirken hata oluştu:", error);
                resultMessage.textContent += " Kod gönderilirken hata oluştu.";
                errorMessageElement.textContent = `Gönderim Hatası: ${error.message}`;
            });
        }

        function onScanFailure(error) {
            // Genellikle tarama başarısız olduğunda çağrılır, ancak sürekli olarak çağrılabilir.
            // Çok fazla loglama yapmamak için dikkatli olun.
            // console.warn(`QR Kod tarama hatası = ${error}`);
        }

        function startScanner() {
            qrReaderContainer.style.display = 'flex';
            statusContainer.style.display = 'none';
            errorMessageElement.textContent = ''; // Hata mesajını temizle

            // Eğer daha önce bir tarayıcı başlatıldıysa ve durdurulduysa, temizle.
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Eski tarayıcı durdurulamadı", err));
            }

            html5QrCode = new Html5Qrcode("qr-reader");
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 }, // Tarama kutusunun boyutu
                aspectRatio: 1.0, // Genellikle kare QR kodlar için 1.0 iyidir
                experimentalFeatures: {
                    useBarCodeDetectorIfSupported: true
                },
                rememberLastUsedCamera: true // Son kullanılan kamerayı hatırla
            };

            // Arka kamerayı tercih et
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    let cameraId = devices.length > 1 ? devices[devices.length - 1].id : devices[0].id; // Genellikle son kamera arka kameradır
                    // Kullanıcıya kamera seçimi sunmak daha iyi bir UX olabilir
                    // Ancak isteğiniz doğrudan arka kamera olduğu için bu şekilde ilerliyoruz.

                    html5QrCode.start(
                        { deviceId: { exact: cameraId } }, // Arka kamerayı zorla
                        // VEYA daha esnek bir yaklaşım:
                        // { facingMode: "environment" },
                        config,
                        onScanSuccess,
                        onScanFailure
                    ).catch((err) => {
                        console.error("QR Kod tarayıcı başlatılamadı:", err);
                        errorMessageElement.textContent = `Kamera başlatılamadı: ${err.message}. Lütfen kamera iznini kontrol edin ve sayfayı yenileyin.`;
                        // Fallback olarak varsayılan kamerayı deneyebiliriz
                        html5QrCode.start(
                            { facingMode: "environment" }, // Eğer exact ID çalışmazsa genel arka kamera modu
                            config,
                            onScanSuccess,
                            onScanFailure
                        ).catch(e => {
                             console.error("Fallback kamera da başlatılamadı:", e);
                             errorMessageElement.textContent += ` Varsayılan arka kamera da bulunamadı. ${e.message}`;
                             qrReaderContainer.style.display = 'none';
                             statusContainer.style.display = 'block';
                             resultMessage.textContent = 'Kamera başlatılamadı.';
                        });
                    });
                } else {
                    console.error("Kamera bulunamadı.");
                    errorMessageElement.textContent = "Kullanılabilir kamera bulunamadı.";
                    qrReaderContainer.style.display = 'none';
                    statusContainer.style.display = 'block';
                    resultMessage.textContent = 'Kamera bulunamadı.';
                }
            }).catch(err => {
                console.error("Kameralar getirilemedi:", err);
                errorMessageElement.textContent = `Kameralar listelenemedi: ${err.message}`;
                qrReaderContainer.style.display = 'none';
                statusContainer.style.display = 'block';
                resultMessage.textContent = 'Kameralar listelenemedi.';
            });
        }

        retryButton.addEventListener('click', () => {
            startScanner();
        });

        // Sayfa yüklendiğinde tarayıcıyı başlat
        document.addEventListener('DOMContentLoaded', (event) => {
            startScanner();
        });
    </script>
</body>
</html>
