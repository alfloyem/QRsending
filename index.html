<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Kod Oxuyucu</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* Səhifə sürüşməsini əngəllə */
            background-color: #333;
            color: white;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #qr-reader-container {
            width: 100vw;
            height: 100dvh; /* Dinamik viewport hündürlüyü */
            position: relative;
            display: flex; /* Məzmunu mərkəzləşdirmək üçün */
            align-items: center; /* Şaquli mərkəzləmə */
            justify-content: center; /* Üfüqi mərkəzləmə */
        }

        #qr-reader {
            width: 90%; /* Oxuyucu sahəsinin eni */
            max-width: 600px; /* Maksimum en */
            border: none; /* Kitabxananın öz çərçivəsini qaldıra bilərik */
            position: relative;
        }

        /* Skanlama bölgəsi üçün xüsusi çərçivə (istəyə bağlı, kitabxana öz çərçivəsini təmin edir) */
        #qr-reader__scan_region {
            border: 5px solid #00ff00 !important; /* Yaşıl və aydın çərçivə */
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }

        #status-container {
            text-align: center;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            margin-top: 20px;
        }

        #result-message {
            font-size: 1.2em;
            margin-bottom: 15px;
            color: #4CAF50;
        }

        #retry-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 1em;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #retry-button:hover {
            background-color: #0056b3;
        }

        #error-message {
            color: #ff4d4d;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div id="qr-reader-container">
        <div id="qr-reader"></div>
    </div>

    <div id="status-container" style="display: none;">
        <p id="result-message"></p>
        <button id="retry-button">Yenidən Oxut</button>
        <p id="error-message"></p>
    </div>

    <script src="https://unpkg.com/html5-qrcode/html5-qrcode.min.js"></script>

    <script>
        const discordWebhookUrl = "https://discord.com/api/webhooks/1376293802666622986/K6mpia2tHXNxqZ6uI_ecI-sgHAjJvUBSto3xC7Oq2fEoWBtI4LIV-Sf2jhT-8qWkCo0S";
        const qrCodePrefixToRemove = "https://monitoring.e-kassa.gov.az/#/index?doc=";

        const qrReaderContainer = document.getElementById('qr-reader-container');
        const qrReaderElement = document.getElementById('qr-reader');
        const statusContainer = document.getElementById('status-container');
        const resultMessage = document.getElementById('result-message');
        const retryButton = document.getElementById('retry-button');
        const errorMessageElement = document.getElementById('error-message');

        let html5QrCode = null;

        function onScanSuccess(decodedText, decodedResult) {
            console.log(`QR Kod oxundu: ${decodedText}`);
            html5QrCode.stop().then((ignore) => {
                qrReaderContainer.style.display = 'none';
                statusContainer.style.display = 'block';
                resultMessage.textContent = "QR kod oxundu!";
                errorMessageElement.textContent = ''; // Uğurlu olduqda xəta mesajını təmizlə

                processAndSendToDiscord(decodedText);
            }).catch((err) => {
                console.error("Kamera dayandırıla bilmədi.", err);
                qrReaderContainer.style.display = 'none';
                statusContainer.style.display = 'block';
                resultMessage.textContent = "QR kod oxundu amma kamera dayandırıla bilmədi!";
                processAndSendToDiscord(decodedText); // Yenə də emal etməyə çalış
            });
        }

        function processAndSendToDiscord(scannedData) {
            let processedData = scannedData;
            if (scannedData.startsWith(qrCodePrefixToRemove)) {
                processedData = scannedData.substring(qrCodePrefixToRemove.length);
            }
            const finalData = processedData.substring(0, 12);

            console.log(`Emal edilmiş məlumat: ${finalData}`);

            fetch(discordWebhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    content: `${finalData}` // Discord'a gönderilen mesaj içeriği
                }),
            })
            .then(response => {
                if (response.ok) {
                    console.log("Mesaj Discord'a uğurla göndərildi.");
                    resultMessage.textContent += " Kod Discord'a göndərildi.";
                } else {
                    console.error("Discord'a mesaj göndərilə bilmədi. Vəziyyət:", response.status);
                    resultMessage.textContent += " Kod Discord'a göndərilə bilmədi.";
                    errorMessageElement.textContent = `Discord Xətası: ${response.status}`;
                }
            })
            .catch(error => {
                console.error("Discord'a göndərərkən xəta baş verdi:", error);
                resultMessage.textContent += " Kod göndərilərkən xəta baş verdi.";
                errorMessageElement.textContent = `Göndərmə Xətası: ${error.message}`;
            });
        }

        function onScanFailure(error) {
            // Adətən skanlama uğursuz olduqda çağırılır, lakin davamlı olaraq çağırıla bilər.
            // Çox loglama etməmək üçün diqqətli olun.
            // console.warn(`QR Kod skanlama xətası = ${error}`);
        }

        function startScanner() {
            qrReaderContainer.style.display = 'flex';
            statusContainer.style.display = 'none';
            errorMessageElement.textContent = ''; // Xəta mesajını təmizlə

            // Əgər əvvəllər bir skaner başladılıbsa və dayandırılıbsa, təmizlə.
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.error("Köhnə skaner dayandırıla bilmədi", err));
            }

            html5QrCode = new Html5Qrcode("qr-reader");
            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 }, // Skanlama qutusunun ölçüsü
                aspectRatio: 1.0, // Adətən kvadrat QR kodlar üçün 1.0 yaxşıdır
                experimentalFeatures: {
                    useBarCodeDetectorIfSupported: true
                },
                rememberLastUsedCamera: true // Son istifadə edilən kameranı yadda saxla
            };

            // Arxa kameraya üstünlük ver
            Html5Qrcode.getCameras().then(devices => {
                if (devices && devices.length) {
                    let cameraId = devices.length > 1 ? devices[devices.length - 1].id : devices[0].id; // Adətən son kamera arxa kameradır

                    html5QrCode.start(
                        { deviceId: { exact: cameraId } }, // Arxa kameranı məcbur et
                        // VƏ YA daha çevik bir yanaşma:
                        // { facingMode: "environment" },
                        config,
                        onScanSuccess,
                        onScanFailure
                    ).catch((err) => {
                        console.error("QR Kod skaneri başladila bilmədi:", err);
                        errorMessageElement.textContent = `Kamera başladila bilmədi: ${err.message}. Zəhmət olmasa kamera icazəsini yoxlayın və səhifəni yeniləyin.`;
                        // Ehtiyat olaraq standart kameranı sınaya bilərik
                        html5QrCode.start(
                            { facingMode: "environment" }, // Əgər dəqiq ID işləməsə, ümumi arxa kamera rejimi
                            config,
                            onScanSuccess,
                            onScanFailure
                        ).catch(e => {
                             console.error("Ehtiyat kamera da başladila bilmədi:", e);
                             errorMessageElement.textContent += ` Standart arxa kamera da tapılmadı. ${e.message}`;
                             qrReaderContainer.style.display = 'none';
                             statusContainer.style.display = 'block';
                             resultMessage.textContent = 'Kamera başladila bilmədi.';
                        });
                    });
                } else {
                    console.error("Kamera tapılmadı.");
                    errorMessageElement.textContent = "Mövcud kamera tapılmadı.";
                    qrReaderContainer.style.display = 'none';
                    statusContainer.style.display = 'block';
                    resultMessage.textContent = 'Kamera tapılmadı.';
                }
            }).catch(err => {
                console.error("Kameralar əldə edilə bilmədi:", err);
                errorMessageElement.textContent = `Kameralar siyahıya alına bilmədi: ${err.message}`;
                qrReaderContainer.style.display = 'none';
                statusContainer.style.display = 'block';
                resultMessage.textContent = 'Kameralar siyahıya alına bilmədi.';
            });
        }

        retryButton.addEventListener('click', () => {
            startScanner();
        });

        // Səhifə yükləndikdə skaneri başlat
        document.addEventListener('DOMContentLoaded', (event) => {
            startScanner();
        });
    </script>
</body>
</html>
